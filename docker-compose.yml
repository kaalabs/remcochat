services:
  remcochat:
    build:
      context: .
    container_name: remcochat
    restart: unless-stopped
    init: true
    extra_hosts:
      # Linux Docker does not always provide host.docker.internal by default.
      # Map it explicitly so Hue Gateway fallback URL works from inside the app container.
      - "host.docker.internal:host-gateway"
    ports:
      - "127.0.0.1:3100:3000"
    environment:
      NODE_ENV: production
      NEXT_TELEMETRY_DISABLED: "1"
      REMCOCHAT_DB_PATH: /app/data/remcochat.sqlite
      REMCOCHAT_CONFIG_PATH: /app/config/config.toml
      REMCOCHAT_ENABLE_ADMIN: ${REMCOCHAT_ENABLE_ADMIN:-0}
      REMCOCHAT_ENABLE_BASH_TOOL: ${REMCOCHAT_ENABLE_BASH_TOOL:-0}
      REMCOCHAT_ADMIN_TOKEN: ${REMCOCHAT_ADMIN_TOKEN:-}
      VERCEL_AI_GATEWAY_API_KEY: ${VERCEL_AI_GATEWAY_API_KEY:-}
      OPENCODE_API_KEY: ${OPENCODE_API_KEY:-}
      EXA_API_KEY: ${EXA_API_KEY:-}
      BRAVE_SEARCH_API: ${BRAVE_SEARCH_API:-}
      BRAVE_API_KEY: ${BRAVE_API_KEY:-}
      NS_APP_SUBSCRIPTION_KEY: ${NS_APP_SUBSCRIPTION_KEY:-}
      HUE_AUTH_HEADER: ${HUE_AUTH_HEADER:-}
      HUE_TOKEN: ${HUE_TOKEN:-}
      HUE_API_KEY: ${HUE_API_KEY:-}
    volumes:
      - remcochat_data:/app/data
      - remcochat_config:/app/config
      # Bind-mount config for restart-only reloads (no rebuild needed).
      # Allow docker deployments to mount a different config without changing the repo file.
      # Example: REMCOCHAT_CONFIG_TOML=./config.docker.toml
      - ${REMCOCHAT_CONFIG_TOML:-./config.toml}:/app/config.seed.toml:ro
      # Host-side modelsdev installation directory (must contain `bin/modelsdev`).
      # Use a RemcoChat-specific env var to avoid collisions with globally-exported vars.
      - ${REMCOCHAT_MODELSDEV_CLI_HOST_DIR:-/usr/local/lib/modelsdev}:/usr/local/lib/modelsdev:ro
    depends_on:
      - sandboxd

  sandboxd:
    build:
      context: .
      dockerfile: sandboxd/Dockerfile
    container_name: remcochat-sandboxd
    restart: unless-stopped
    environment:
      SANDBOXD_BIND_HOST: "0.0.0.0"
      # Publish sandbox ports (sandboxUrl) only on a restricted host interface.
      SANDBOXD_PUBLISH_HOST_IP: "${SANDBOXD_PUBLISH_HOST_IP:-127.0.0.1}"
      SANDBOXD_ADMIN_TOKEN: "${REMCOCHAT_ADMIN_TOKEN:-}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  remcochat_data:
  remcochat_config:
