# Reverse proxy for RemcoChat under a path prefix.
#
# Target URL:
#   http://klubnt01/remcochat
#
# NOTE: RemcoChat (Next.js) serves assets + API under absolute root paths (e.g. /_next, /api, /icons, /fonts),
# so this config also proxies those root paths to the remcochat upstream.

map $http_upgrade $connection_upgrade {
  default upgrade;
  "" close;
}

server {
  listen 80;
  server_name klubnt01;

  client_max_body_size 25m;

  # Download the local CA certificate (install/trust this on clients to remove Safari warnings).
  location = /remcochat-ca.pem {
    default_type application/x-pem-file;
    add_header Cache-Control "no-store";
    alias /etc/nginx/certs/ca.pem;
  }

  location = /remcochat-ca.cer {
    default_type application/x-x509-ca-cert;
    add_header Cache-Control "no-store";
    alias /etc/nginx/certs/ca.cer;
  }

  location = /remcochat-ca.mobileconfig {
    default_type application/x-apple-aspen-config;
    add_header Cache-Control "no-store";
    add_header Content-Disposition "attachment; filename=remcochat-ca.mobileconfig";
    alias /etc/nginx/certs/remcochat-ca.mobileconfig;
  }

  location = / {
    return 302 /remcochat/;
  }

  location = /remcochat {
    return 301 /remcochat/;
  }

  location ^~ /remcochat/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Prefix /remcochat;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    # Trailing slash strips the /remcochat/ prefix for the upstream.
    proxy_pass http://remcochat:3000/;
  }

  # RemcoChat serves these from absolute root paths.
  location ^~ /_next/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_pass http://remcochat:3000/_next/;
  }

  location ^~ /icons/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_pass http://remcochat:3000/icons/;
  }

  location ^~ /fonts/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_pass http://remcochat:3000/fonts/;
  }

  location ^~ /api/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_pass http://remcochat:3000/api/;
  }

  location ^~ /admin {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_pass http://remcochat:3000/admin;
  }

  location = /favicon.ico {
    proxy_pass http://remcochat:3000/favicon.ico;
  }

  location = /robots.txt {
    proxy_pass http://remcochat:3000/robots.txt;
  }

  # Keep everything else off the root by default.
  location / {
    return 404;
  }
}

server {
  listen 443 ssl;
  server_name klubnt01;

  # Self-signed certs are supported (see scripts/generate-proxy-cert.sh).
  # Provide your own certs by placing them here (PEM format):
  #   nginx/certs/tls.pem
  #   nginx/certs/tls.key
  #
  # Note: the local CA private key is stored host-only at:
  #   nginx/ca/ca.key
  # and is NOT mounted into the nginx container.
  ssl_certificate /etc/nginx/certs/tls.pem;
  ssl_certificate_key /etc/nginx/certs/tls.key;

  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:10m;
  ssl_session_tickets off;

  ssl_protocols TLSv1.2 TLSv1.3;

  client_max_body_size 25m;

  # Download the local CA certificate (install/trust this on clients to remove Safari warnings).
  location = /remcochat-ca.pem {
    default_type application/x-pem-file;
    add_header Cache-Control "no-store";
    alias /etc/nginx/certs/ca.pem;
  }

  location = /remcochat-ca.cer {
    default_type application/x-x509-ca-cert;
    add_header Cache-Control "no-store";
    alias /etc/nginx/certs/ca.cer;
  }

  location = /remcochat-ca.mobileconfig {
    default_type application/x-apple-aspen-config;
    add_header Cache-Control "no-store";
    add_header Content-Disposition "attachment; filename=remcochat-ca.mobileconfig";
    alias /etc/nginx/certs/remcochat-ca.mobileconfig;
  }

  location = / {
    return 302 /remcochat/;
  }

  location = /remcochat {
    return 301 /remcochat/;
  }

  location ^~ /remcochat/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Prefix /remcochat;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    proxy_pass http://remcochat:3000/;
  }

  location ^~ /_next/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_pass http://remcochat:3000/_next/;
  }

  location ^~ /icons/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_pass http://remcochat:3000/icons/;
  }

  location ^~ /fonts/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_pass http://remcochat:3000/fonts/;
  }

  location ^~ /api/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_pass http://remcochat:3000/api/;
  }

  location ^~ /admin {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_buffering off;
    proxy_pass http://remcochat:3000/admin;
  }

  location = /favicon.ico {
    proxy_pass http://remcochat:3000/favicon.ico;
  }

  location = /robots.txt {
    proxy_pass http://remcochat:3000/robots.txt;
  }

  location / {
    return 404;
  }
}

server {
  listen 80;
  server_name blog.remcokortekaas.nl;

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type text/plain;
    try_files $uri =404;
  }

  location / {
    return 301 https://$host$request_uri;
  }
}

server {
  listen 443 ssl;
  server_name blog.remcokortekaas.nl;

  ssl_certificate /etc/letsencrypt/live/blog.remcokortekaas.nl/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/blog.remcokortekaas.nl/privkey.pem;

  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:10m;
  ssl_session_tickets off;

  ssl_protocols TLSv1.2 TLSv1.3;

  add_header Strict-Transport-Security "max-age=31536000" always;

  location ^~ /.well-known/acme-challenge/ {
    root /var/www/certbot;
    default_type text/plain;
    try_files $uri =404;
  }

  location / {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $host;
    proxy_pass http://192.168.1.111:8888;
  }
}
