schema_version = 1
project = "RemcoChat"
plan_file = "PLAN.md"
created_at = "2026-01-13T15:34:03Z"
updated_at = "2026-01-14T15:38:49Z"

# PROGRESS.toml is an append-only, historical audit trail.
# Do not pre-create tasks, statuses, or future work items here.
#
# After completing a canonical task from `PLAN.md`, append a new `[[events]]`
# record that describes what was done and why, including:
# - task: a short label or PLAN.md roadmap step reference
# - summary: one-line outcome
# - challenges: what went wrong / tricky parts
# - solutions: how it was solved and why
# - tests: exact commands run + outcome
# - files: notable files changed

[[events]]
ts = "2026-01-13T15:34:03Z"
type = "meta"
summary = "Initialized planning docs and progress tracking"
files = ["PLAN.md", "AGENTS.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T15:34:31Z"
type = "meta"
summary = "Documented PROGRESS.toml workflow in AGENTS.md"
files = ["AGENTS.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T15:38:19Z"
type = "meta"
summary = "Refactored PROGRESS.toml to be historical-only (append-only)"
details = "Removed forward-looking task status tracking; PROGRESS.toml now records only completed work after the fact."
files = ["PROGRESS.toml", "AGENTS.md"]

[[events]]
ts = "2026-01-13T15:47:35Z"
type = "task"
task = "Implementation Roadmap 1: Scaffold Next.js + Tailwind + shadcn/ui; install AI SDK; install AI Elements"
summary = "Bootstrapped a Next.js (App Router) project with Tailwind v4, installed Vercel AI SDK + AI Elements, and ensured lint/build succeed."
challenges = [
  "create-next-app refused to initialize in the repo root due to npm package naming restrictions (repo directory contains capital letters).",
  "AI Elements generated components that failed TypeScript build due to unused '@ts-expect-error' directives.",
  "AI Elements generated components that triggered strict React Hooks ESLint rules from the default Next.js flat config.",
]
solutions = [
  "Scaffolded in a lowercase subdirectory and then moved the Next.js project files into the repo root.",
  "Removed unused '@ts-expect-error' directives in AI Elements components so TypeScript compilation passes with the installed AI SDK version.",
  "Added ESLint flat-config overrides to relax selected rules for vendored AI Elements code (kept rules enabled for the rest of the app).",
]
decisions = [
  "Kept the app stack on latest versions (Next 16.x / React 19.x / Tailwind 4.x / AI SDK 6.x) to match AI Elements expectations.",
  "Did not delete unused AI Elements component files; they are present but will only be used selectively per MVP scope.",
]
tests = [
  "npm run lint (pass; warnings from ai-elements remain)",
  "npm run build (pass)",
]
files = [
  ".gitignore",
  "eslint.config.mjs",
  "package.json",
  "package-lock.json",
  "next.config.ts",
  "postcss.config.mjs",
  "tsconfig.json",
  "src/**",
  "public/**",
  "src/components/ai-elements/confirmation.tsx",
  "src/components/ai-elements/tool.tsx",
  "components.json",
]

[[events]]
ts = "2026-01-13T15:51:02Z"
type = "task"
task = "Implementation Roadmap 2: Build base layout + theme toggle"
summary = "Replaced the starter landing page with a RemcoChat shell (sidebar + main area) and added a working light/dark theme toggle."
challenges = [
  "next-themes type import path used in some examples was not present in the installed next-themes version.",
  "Default Next.js ESLint rules flagged the common 'mounted' pattern used to avoid theme hydration mismatches.",
]
solutions = [
  "Typed ThemeProvider props via React ComponentProps instead of importing from an internal next-themes path.",
  "Scoped an ESLint override to disable the overly-strict hook rule for theme-toggle while keeping it enabled elsewhere.",
]
tests = [
  "npm run lint (pass; warnings remain in ai-elements vendored code)",
  "npm run build (pass)",
]
files = [
  "src/app/layout.tsx",
  "src/app/page.tsx",
  "src/components/theme-provider.tsx",
  "src/components/theme-toggle.tsx",
  "eslint.config.mjs",
  "package.json",
  "package-lock.json",
]

[[events]]
ts = "2026-01-13T15:52:48Z"
type = "task"
task = "Implementation Roadmap 3: Add model allowlist + per-chat model selector"
summary = "Added a model allowlist and a minimal model selector UI in the header (currently persisted as a global default in localStorage until chats/profiles are implemented)."
decisions = [
  "Initial allowlist set to: openai/gpt-5, openai/gpt-4.1-mini, anthropic/claude-sonnet-4.5 (easy to adjust later).",
  "Persisted selection in localStorage as 'remcochat:modelId' as an interim default; will move to per-chat storage once chats exist.",
]
tests = [
  "npm run lint (pass; warnings remain in ai-elements vendored code)",
  "npm run build (pass)",
]
files = [
  "src/lib/models.ts",
  "src/components/model-picker.tsx",
  "src/app/page.tsx",
  "PLAN.md",
]

[[events]]
ts = "2026-01-13T15:57:25Z"
type = "task"
task = "Implementation Roadmap 4: Implement streaming /api/chat + Stop (abort)"
summary = "Implemented `/api/chat` streaming via AI SDK + AI Gateway, wired a basic chat UI using `useChat` with streaming, and added a Stop button."
challenges = [
  "AI Elements `PromptInput` requires an `onSubmit` prop and expects the textarea to provide a `name` for form submission.",
  "`useChat` helper in the installed `@ai-sdk/react` version exposes `regenerate` (not `reload`) for retry behavior.",
]
solutions = [
  "Switched from a custom `<form>` wrapper to `PromptInput`'s built-in form and provided `onSubmit` plus `name=\"message\"` on the textarea.",
  "Used `regenerate()` for retry in the error UI and `stop()` to abort streaming.",
]
tests = [
  "npm run build (pass)",
  "npm run lint (pass; warnings remain in ai-elements vendored code)",
]
files = [
  ".env.example",
  "src/app/api/chat/route.ts",
  "src/app/page.tsx",
]

[[events]]
ts = "2026-01-13T16:04:21Z"
type = "task"
task = "Implementation Roadmap 5: Add profiles (create/switch) + profileId routing"
summary = "Added server-side profiles backed by SQLite, profile list/create/update APIs, and a profile switcher UI; chat requests now include the active profileId."
challenges = [
  "Needed a minimal persistence layer without introducing heavy migration tooling.",
  "better-sqlite3 required separate TypeScript types to keep `next build` green.",
]
solutions = [
  "Implemented a tiny SQLite bootstrapper (`src/server/db.ts`) that creates the `profiles` table on first run (DB stored under `data/`, ignored by git).",
  "Added `@types/better-sqlite3` and typed DB rows explicitly to avoid `any` and satisfy strict lint rules.",
]
decisions = [
  "Active profile selection is stored client-side in localStorage (`remcochat:profileId`), but profile definitions live on the server and are shared on the LAN.",
  "Moved 'default model' to be profile-backed (PATCH `/api/profiles/:id`), aligning with the plan’s profile-based defaults.",
]
tests = [
  "npm run build (pass)",
  "npm run lint (pass; warnings remain in ai-elements vendored code)",
]
files = [
  ".gitignore",
  "src/server/db.ts",
  "src/server/profiles.ts",
  "src/app/api/profiles/route.ts",
  "src/app/api/profiles/[profileId]/route.ts",
  "src/app/home-client.tsx",
  "src/app/page.tsx",
  "src/lib/types.ts",
  "package.json",
  "package-lock.json",
]

[[events]]
ts = "2026-01-13T16:05:30Z"
type = "meta"
summary = "Added minimal README run instructions"
files = ["README.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T16:16:52Z"
type = "meta"
summary = "Require AI Gateway key from shell for npm run dev/start"
details = "Added a small preflight script so `npm run dev`/`npm run start` fail fast unless `VERCEL_AI_GATEWAY_API_KEY` (or `AI_GATEWAY_API_KEY`) is exported in the shell."
tests = ["npm run build (pass)", "npm run lint (pass)"]
files = ["scripts/check-env.mjs", "package.json", "README.md", ".env.example", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T16:25:55Z"
type = "fix"
summary = "Prevent prompt composer from scrolling off-screen"
details = "Constrained layout to viewport, forced scroll to stay in the message list, and capped textarea growth so the composer stays visible while older messages scroll upward."
tests = ["npm run build (pass)", "npm run lint (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T16:29:18Z"
type = "fix"
summary = "Fix hydration mismatch in model selector label"
details = "Removed localStorage-dependent state initialization during the first render; active profile is now updated from localStorage only after mount, avoiding SSR/CSR mismatch."
tests = ["npm run build (pass)", "npm run lint (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T16:34:29Z"
type = "fix"
summary = "Auto-scroll chat to bottom while streaming"
details = "Wrapped the message list in `StickToBottom` so streaming updates keep the view anchored to the bottom (older messages scroll off the top once the viewport fills), without fighting the user if they scroll up."
tests = ["npm run build (pass)", "npm run lint (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T16:37:45Z"
type = "feat"
summary = "Add 'Thinking…' indicator while waiting for response"
details = "Shows a small spinner + 'Thinking…' assistant bubble while the request is submitted (or streaming before first token), so users get immediate feedback that the model is working."
tests = ["npm run build (pass)", "npm run lint (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T16:55:35Z"
type = "task"
task = "Implementation Roadmap 6: Add SQLite persistence (chats + messages) + sidebar history"
summary = "Implemented per-profile chat history backed by SQLite (chats + messages), wired chat switching/loading/saving in the UI, and ensured streaming stays pinned to the bottom while the composer remains fixed."
challenges = [
  "A previously-created local SQLite DB had an older `messages` table schema, causing Next.js build/prerender to fail when creating an index on a missing `position` column.",
  "Auto-scroll during streaming was unreliable because the stick-to-bottom scroll container was not the actual element holding the scrollRef.",
]
solutions = [
  "Adjusted schema initialization to run the `position` column migration before creating the `idx_messages_chat_position` index, so older DBs upgrade cleanly.",
  "Restructured the chat scroll area so `use-stick-to-bottom` owns the scrollable element, and applied padding to the content container instead of the wrapper.",
]
decisions = [
  "Persist messages as AI SDK `UIMessage.parts` JSON (`parts_json`) to keep storage aligned with UI rendering and future multi-part messages.",
  "Persist active chat selection per profile in localStorage (`remcochat:chatId:<profileId>`), while chats/messages live on the server and are shared on the LAN.",
]
tests = [
  "npm run build (pass)",
  "npm run lint (pass; warnings remain in vendored ai-elements code)",
]
files = [
  "src/server/db.ts",
  "src/server/chats.ts",
  "src/app/api/chats/route.ts",
  "src/app/api/chats/[chatId]/route.ts",
  "src/app/api/chats/[chatId]/messages/route.ts",
  "src/app/api/chat/route.ts",
  "src/app/home-client.tsx",
  "src/app/page.tsx",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-13T17:07:56Z"
type = "task"
task = "Implementation Roadmap 7: Add regenerate + response variants"
summary = "Added Regenerate and a per-turn variants pager; unselected assistant responses are persisted and can be swapped back in as the selected response."
challenges = [
  "`useChat().regenerate()` replaces the assistant message in-place, so variant history would be lost unless captured and stored separately.",
  "Variant ordering/association needed to be stable across reloads (which user message a response belongs to, and when it was created).",
]
solutions = [
  "Introduced a `message_variants` table to store unselected assistant responses keyed by the user message they answer; the selected assistant response remains in the main `messages` stream.",
  "Added message metadata (`createdAt`, `turnUserMessageId`) via AI SDK `messageMetadata` on the server and persisted metadata on reload via DB columns + response payload.",
  "Changed chat state saving to be a full sync (upsert + delete missing) so regenerated messages don’t leave stale rows behind in SQLite.",
]
tests = [
  "npm run build (pass)",
  "npm run lint (pass; warnings remain in vendored ai-elements code)",
]
files = [
  "src/server/db.ts",
  "src/server/chats.ts",
  "src/app/api/chat/route.ts",
  "src/app/api/chats/[chatId]/messages/route.ts",
  "src/app/home-client.tsx",
  "src/lib/types.ts",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-13T17:48:34Z"
type = "fix"
summary = "Restore message list scrolling + resilient DB migrations"
challenges = [
  "The message list did not scroll because the stick-to-bottom content container was forced to `h-full`, preventing the scroll area from growing its scrollHeight.",
  "Next dev hot-reload can keep the SQLite connection alive, so new migrations may not run if schema init only happens on first connection creation.",
]
solutions = [
  "Removed the `h-full` constraint from the chat scroll content so the scroll container can measure content height and auto-scroll during streaming.",
  "Re-ran schema init/migrations on every `getDb()` call (idempotent) so new columns/tables become available even when the DB connection is reused across reloads.",
]
tests = [
  "npm run build (pass)",
  "npm run lint (pass; warnings remain in vendored ai-elements code)",
]
files = ["src/app/home-client.tsx", "src/server/db.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T17:56:43Z"
type = "fix"
summary = "Prevent reload from overwriting persisted chat state with empty messages"
challenges = [
  "On reload, the auto-save effect could run before the initial messages fetch finished, sending an empty `{messages: []}` payload that wiped chat history in SQLite.",
]
solutions = [
  "Added a per-chat 'loaded' guard so saving only happens after the initial chat state for the active chat has been fetched and applied.",
]
tests = [
  "npm run build (pass)",
  "npm run lint (pass; warnings remain in vendored ai-elements code)",
]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T18:01:36Z"
type = "fix"
summary = "Suppress Radix hydration warnings for Select/ModelPicker trigger ids"
details = "Radix generates dynamic `aria-controls` ids that can differ between SSR and client hydration; we suppress hydration warnings on the affected trigger elements to keep the console clean."
tests = ["npm run build (pass)"]
files = ["src/app/home-client.tsx", "src/components/model-picker.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T18:14:19Z"
type = "task"
task = "Implementation Roadmap 8: Edit + branch (fork chat from a user message)"
summary = "Added per-user-message Edit that forks a new chat from that point, copies prior context, and re-runs the conversation from the edited message."
challenges = [
  "Need to preserve history while ensuring the original chat remains unchanged (fork semantics).",
  "SQLite schema migrations must upgrade existing LAN DBs without breaking older installs.",
]
solutions = [
  "Implemented `forkChatFromUserMessage` that creates a new chat with fork metadata and saves a sliced/edited message stream; variants are carried over only for turns before the edit point.",
  "Added nullable fork metadata columns to the `chats` table with idempotent migrations.",
  "Added a dedicated API endpoint for forking and a minimal dialog UI to edit text and create the fork.",
]
tests = ["npm run build (pass)", "npm run lint (pass; warnings remain in vendored ai-elements code)"]
files = [
  "src/server/db.ts",
  "src/server/chats.ts",
  "src/app/api/chats/[chatId]/fork/route.ts",
  "src/app/home-client.tsx",
  "src/lib/types.ts",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-13T18:25:20Z"
type = "task"
task = "Implementation Roadmap 9: Instructions + memory + temporary chat"
summary = "Added profile custom instructions, per-chat instructions, explicit “Memorize this” memory capture with management, and temporary chat mode that bypasses history and memory."
challenges = [
  "Memory must be explicit-only (no automatic summarization) and must not leak into temporary chats.",
  "Temporary chat needed to work with the existing `/api/chat` transport that previously required a persisted chat id.",
]
solutions = [
  "Added `profile_memory` table + memory APIs and injected saved memory into the system prompt only when `memory_enabled` is on and the request is not temporary.",
  "Extended `/api/chat` to accept `temporary: true` and skip chat/profile DB coupling while still streaming via AI Gateway.",
  "Added UI: profile settings dialog (custom instructions + memory toggle + memory list/delete), chat settings dialog (per-chat instructions), and a “Memorize this” action on user messages.",
]
tests = [
  "npm run build (pass)",
  "npm run lint (pass; warnings remain in vendored ai-elements code)",
]
files = [
  "src/server/db.ts",
  "src/server/memory.ts",
  "src/app/api/profiles/[profileId]/memory/route.ts",
  "src/app/api/profiles/[profileId]/memory/[memoryId]/route.ts",
  "src/app/api/chat/route.ts",
  "src/app/home-client.tsx",
  "src/lib/types.ts",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-13T18:26:10Z"
type = "fix"
summary = "Temp chat inherits current model selection"
details = "When entering temporary chat, it now starts with the currently selected model instead of resetting to a hardcoded default."
tests = ["npm run build (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T18:46:52Z"
type = "fix"
summary = "Make instructions + memory behave consistently"
challenges = [
  "Profile/chat instructions appeared to apply inconsistently across multiple turns, and “Memorize this” was not discoverable enough in the message UI.",
]
solutions = [
  "Prepended the assembled system prompt as an explicit system message in the model message list for every request, and added an explicit priority rule (chat > profile > memory).",
  "Made per-user-message actions (including “Memorize this”) visible by default at low opacity instead of only on hover.",
]
tests = ["npm run build (pass)", "npm run lint (pass; warnings remain in vendored ai-elements code)"]
files = ["src/app/api/chat/route.ts", "src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T19:01:53Z"
type = "fix"
summary = "Use official AI Gateway provider and add “Memorize this,” command"
challenges = [
  "Profile/chat system instructions were not applied reliably across turns when using a plain string `modelId` without the AI Gateway provider.",
  "Memory capture required too much manual UI interaction; MVP requires command-style memory capture.",
]
solutions = [
  "Added `@ai-sdk/gateway` and switched `/api/chat` to `model: gateway('<provider>/<model>')`, restoring reliable system prompt handling for both profile and per-chat instructions.",
  "Implemented a lightweight command parser for user messages starting with “Memorize this,”; when memory is enabled and chat is non-temporary, it saves directly to `profile_memory` and returns a synthetic streamed assistant confirmation without calling the model.",
]
tests = [
  "npm run build (pass)",
  "npm run lint (pass; warnings remain in vendored ai-elements code)",
]
files = [
  "package.json",
  "package-lock.json",
  "src/app/api/chat/route.ts",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-13T19:39:54Z"
type = "fix"
summary = "Make chat instructions override profile instructions"
details = "Reworked system prompt assembly so Chat instructions are explicitly highest priority and included last, preventing profile-level instructions from overriding per-chat behavior."
tests = ["npm run build (pass)", "npm run lint (pass; warnings remain in vendored ai-elements code)"]
files = ["src/app/api/chat/route.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T20:35:02Z"
type = "investigation"
summary = "Investigated Claude instruction persistence across turns"
challenges = [
  "User reported that on anthropic/claude-sonnet-4.5 profile instructions apply only to the first prompt; follow-up prompts ignore them (OpenAI models behaved consistently).",
  "The issue reproduced when instructions were phrased like “Reply with exactly: …”.",
]
solutions = [
  "Adjusted system prompt wording to explicitly scope both Profile + Chat instructions as constraints that apply to every assistant response (not just the first reply).",
  "Verified via a local scripted reproduction calling `/api/chat` twice in the same conversation with the Claude model id; behavior became consistent (PROFILE-OK on both turns).",
]
tests = ["npm run build (pass)"]
files = ["src/app/api/chat/route.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T20:42:23Z"
type = "fix"
summary = "Make chat instruction changes apply mid-chat even with profile instructions present"
challenges = [
  "User reported that updating Chat instructions mid-chat had no effect; it only worked when starting a new chat after setting Chat instructions.",
  "Local reproduction showed chat instructions failed to override profile instructions when both were present, depending on prompt section ordering.",
]
solutions = [
  "Reordered system prompt sections so Memory is included first (lowest priority), Profile instructions next, and Chat instructions last (highest priority) to reduce ordering-related ambiguity across providers.",
  "Kept explicit priority guidance in the system prompt while also aligning section order with that priority.",
]
tests = ["npm run build (pass)"]
files = ["src/app/api/chat/route.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T20:48:43Z"
type = "fix"
summary = "Stabilize repeated mid-chat instruction updates (Claude) with exact-response mode"
challenges = [
  "Claude could continue outputting the previous instruction's exact token (e.g. CHAT-OK) even after chat instructions were updated again mid-chat (e.g. CHAT-NEW), despite the server sending the updated system prompt.",
  "This was easiest to reproduce using test-style instructions like “Reply with exactly: …”, where the model tended to follow prior assistant outputs as an implicit pattern.",
]
solutions = [
  "Added lightweight parsing for common “exact response” instruction patterns in profile/chat instructions and injected an explicit “Exact-response mode” directive into the system prompt, including guidance to ignore outdated prior assistant messages.",
  "Kept prompt section ordering aligned with declared priority (Memory → Profile → Chat).",
]
tests = [
  "node (manual script) to create profile+chat, PATCH chat instructions twice mid-chat, and call /api/chat 3 turns (pass for anthropic/claude-sonnet-4.5 and openai/gpt-4.1-mini)",
  "npm run build (pass)",
]
files = ["src/app/api/chat/route.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T21:02:43Z"
type = "refactor"
summary = "Replace instruction pattern-matching with revisioned instruction framing"
challenges = [
  "Pattern-matching on instruction text (e.g. 'Reply with exactly: …') made the system less flexible and felt like hard-coded policy instead of a general agentic approach.",
  "Need a provider-agnostic way to make mid-chat instruction updates take effect even when prior assistant messages set a conflicting pattern.",
]
solutions = [
  "Added revision counters for profile and chat instructions in the DB (`custom_instructions_revision`, `chat_instructions_revision`) and increment them only when instructions change.",
  "Reworked system prompt assembly to include both a plain-text 'Current instructions' section and a structured `<instruction_frame>` block containing revisions; instruct the model to treat newer revisions as authoritative and ignore conflicting prior assistant messages as outdated examples.",
  "Removed the prior instruction text parsing / exact-response mode logic from the server; the model now interprets instructions naturally within the revisioned frame.",
]
tests = [
  "node (manual script) to PATCH chat instructions twice mid-chat and call /api/chat for 3 turns (pass for anthropic/claude-sonnet-4.5 and openai/gpt-4.1-mini)",
  "npm run build (pass)",
]
files = [
  "src/server/db.ts",
  "src/server/profiles.ts",
  "src/server/chats.ts",
  "src/lib/types.ts",
  "src/app/api/chat/route.ts",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-13T21:14:35Z"
type = "investigation"
summary = "Added debug headers to /api/chat to diagnose instruction update issues in the UI"
details = "Response headers now include api version plus profile/chat instruction revision numbers so UI tests can confirm whether requests are hitting the updated server code and whether instruction updates are observed by the backend."
tests = ["npm run build (pass)", "node (manual script) verified x-remcochat-* headers and chat instruction rev increments 1→2→3 (pass)"]
files = ["src/app/api/chat/route.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T21:25:37Z"
type = "fix"
summary = "Prevent sending messages against the wrong chat when activeChatId is stale"
challenges = [
  "UI reports of 'mid-chat instructions not applying' correlated with chats not showing an incremented chatInstructionsRevision, suggesting the UI may be editing one chat while sending messages to another due to fallback selection behavior.",
]
solutions = [
  "Removed the fallback that silently selected chats[0] when activeChatId was missing or invalid; activeChat is now null in that case.",
  "Aligned useChat session key to activeChat.id and added an effect to restore a valid activeChatId when chats exist, ensuring chat settings and /api/chat requests refer to the same chat consistently.",
  "After saving chat settings, re-fetch chats from the server to keep client state aligned with persisted chat instruction revisions.",
]
tests = ["npm run build (pass)", "node (manual script) verified mid-chat chat instruction changes still apply (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T21:37:51Z"
type = "ux"
summary = "Clarify when instruction edits take effect and avoid editing while a response is in-flight"
details = "Chat/Profile settings buttons are disabled while the assistant is streaming/submitted, and the Chat settings dialog now states that changes apply starting with the next assistant response."
tests = ["npm run build (pass)"]
files = ["src/app/home-client.tsx", "src/app/api/chat/route.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-13T21:43:10Z"
type = "fix"
summary = "Pin Chat Settings edits to the chat that was opened"
details = "Captures the chatId when opening Chat Settings and uses that id for saving, preventing background chat list refreshes from switching the active chat and causing instruction edits to apply to a different chat than the user expects."
tests = ["npm run build (pass)", "node (manual script) mid-chat instructions update PROFILE-OK→CHAT-OK→CHAT-NEW (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T03:04:30Z"
type = "task"
task = "Testing: Add Playwright WebKit E2E + fix instruction updates"
summary = "Added Playwright (WebKit/Safari engine) end-to-end testing and fixed instruction update behavior for Claude by tracking instruction revisions per assistant message and filtering stale assistant messages after instruction updates."
challenges = [
  "Claude would continue following earlier instruction patterns after mid-chat instruction changes, even when the server system prompt reflected updated instruction revisions.",
  "Strict 'exact output' assertions made real-LLM E2E flaky (providers sometimes add extra text or repeat lines despite temperature=0).",
]
solutions = [
  "Included `profileInstructionsRevision`/`chatInstructionsRevision` in assistant message metadata and persisted them in SQLite so the server can drop assistant messages created under older instruction revisions when building the next model request.",
  "Added stable `data-testid` selectors and made the E2E assertions focus on inclusion/exclusion of the expected instruction token instead of exact-match output.",
]
decisions = [
  "E2E runs against a dedicated DB (`data/remcochat-e2e.sqlite`) and uses Playwright WebKit to approximate Safari behavior.",
  "Kept the existing fast-fail requirement for `VERCEL_AI_GATEWAY_API_KEY`; E2E is intended to run with real LLM access (no mocks).",
]
tests = [
  "npx playwright install webkit (pass)",
  "npm run build (pass)",
  "npm run lint (pass; warnings remain in vendored ai-elements code)",
  "npm run test:e2e (pass)",
]
files = [
  "playwright.config.ts",
  "e2e/instructions.spec.ts",
  "scripts/reset-e2e-db.mjs",
  "package.json",
  "package-lock.json",
  "src/app/home-client.tsx",
  "src/components/model-picker.tsx",
  "src/app/api/chat/route.ts",
  "src/server/db.ts",
  "src/server/chats.ts",
  "src/lib/types.ts",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-14T03:07:16Z"
type = "chore"
summary = "Ignore Playwright artifacts and reduce a new hook lint warning"
tests = ["npm run lint (pass; warnings remain in vendored ai-elements code)"]
files = [".gitignore", "src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T03:07:58Z"
type = "meta"
summary = "Documented Playwright E2E commands in README"
files = ["README.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T03:20:59Z"
type = "fix"
summary = "Regenerate now yields a new response variant instead of repeating the same answer"
details = "The client now marks regenerate requests explicitly; the server drops the prior assistant message being regenerated from context and uses a slightly higher temperature with a regeneration hint. This increases diversity while still respecting profile/chat instruction constraints."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "src/app/api/chat/route.ts", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T03:30:00Z"
type = "fix"
summary = "Reduce A/B oscillation when regenerating by avoiding all prior variants"
details = "Regenerate now snapshots variants with unique ids, and the server includes the selected answer + stored variants for the turn in a 'do not repeat' list. This pushes the model to produce a genuinely new variant across multiple regenerate clicks."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "src/app/api/chat/route.ts", "src/server/chats.ts", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T03:43:14Z"
type = "fix"
summary = "Fix edit+fork dialog crash (PromptInputTextarea outside provider) and add E2E regression"
details = "Replaced the edit dialog's PromptInputTextarea with a plain Textarea and added test selectors; added a WebKit E2E test that regenerates variants, then edits and forks a message without runtime errors."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T04:08:17Z"
type = "fix"
summary = "Regenerate after fork now answers the edited (unanswered) user message"
details = "When a forked chat ends on a user message with no assistant response yet, the Regenerate button now calls `regenerate()` without a messageId so AI SDK generates the assistant response for the last user message, matching user expectations."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T04:17:40Z"
type = "fix"
summary = "Forked chats retain variants for earlier turns"
details = "Fork now flushes the source chat state (including variants) to the server before forking so the server-side fork can copy the latest variants; added variant pager testids and expanded WebKit E2E to assert the pager is present in the forked chat."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T04:34:59Z"
type = "fix"
summary = "Fork preserves the edited turn’s fork-source response variants"
details = "When editing a past user message and forking, the server previously dropped all variants for that edited turn, so after regenerating the edited message in the fork there was no variants pager to return to the original (pre-edit) assistant responses. Fork now carries over the edited turn’s stored variants and also captures the original turn’s assistant response(s) as fork-source variants, aligning with ChatGPT-like branching behavior."
tests = ["npm run test:e2e (pass)", "npm run build (pass)"]
files = ["src/server/chats.ts", "e2e/instructions.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T04:49:21Z"
type = "task"
task = "Implementation Roadmap 10: Add archive/delete + export endpoints"
summary = "Added archive/unarchive and soft-delete chat actions in the sidebar, plus chat export to Markdown and JSON."
challenges = [
  "Needed a reliable, non-manual way to validate the full archive/delete/export flow end-to-end in a Safari-like browser.",
]
solutions = [
  "Implemented dedicated API routes for archive/unarchive, delete, and export; wired them into a minimal dropdown action menu per chat and added a WebKit Playwright E2E that exercises export + archive/unarchive + delete.",
]
decisions = [
  "Delete is implemented as a soft delete (sets deleted_at) and removed from normal chat listings; archiving is reversible (archived_at NULL/ISO timestamp).",
  "Export JSON includes messages plus per-turn unselected variants; Export Markdown includes an appendix for variants.",
]
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = [
  "src/server/chats.ts",
  "src/app/api/chats/[chatId]/route.ts",
  "src/app/api/chats/[chatId]/archive/route.ts",
  "src/app/api/chats/[chatId]/export/route.ts",
  "src/app/home-client.tsx",
  "e2e/instructions.spec.ts",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-14T04:53:18Z"
type = "fix"
summary = "Suppress Radix dropdown trigger hydration mismatch on refresh"
details = "Safari/Next reported hydration attribute mismatches on Radix DropdownMenu trigger ids after refresh. Added suppressHydrationWarning to the sidebar chat menu trigger buttons (similar to the existing SelectTrigger mitigation) to prevent noisy console errors."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T05:01:45Z"
type = "ux"
summary = "Archived chats section is collapsible and collapsed by default"
details = "Moved archived chats under a Radix Collapsible section so they don't clutter the sidebar. The section is collapsed by default, auto-expands after archiving a chat, and auto-collapses when there are no archived chats left."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T05:07:38Z"
type = "polish"
summary = "Added global keyboard shortcuts and improved focus behavior"
details = "Added global shortcuts: Esc stops streaming, Cmd/Ctrl+/ focuses the composer, Cmd/Ctrl+Shift+N creates a new chat (avoids the browser's Cmd/Ctrl+N new-window shortcut), and Cmd/Ctrl+Shift+L toggles theme. The composer now auto-focuses after chat switches and after closing dialogs to keep the flow fast."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "src/components/theme-toggle.tsx", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T05:16:39Z"
type = "ui"
summary = "Introduce a subtle brand accent color per theme"
details = "Updated the shadcn/Tailwind CSS variables to use a subtle blue accent: primary buttons, focus rings, hover accents, and sidebar active/hover states now inherit that single accent color per theme (with light/dark tuned OKLCH values)."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/globals.css", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T05:19:45Z"
type = "ui"
summary = "Increase light-theme accent contrast"
details = "Adjusted light-theme OKLCH values (primary/accent/ring and sidebar equivalents) to make the accent more noticeable while keeping it minimal."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/globals.css", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T05:24:11Z"
type = "ui"
summary = "Use an icon-only regenerate button"
details = "Replaced the composer 'Regenerate' text button with an icon-only button and added an aria-label/title for clarity; updated WebKit E2E to target it via data-testid."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T05:26:12Z"
type = "ui"
summary = "Use an icon-only chat settings button"
details = "Replaced the composer 'Chat' settings text button with an icon-only button (aria-label/title kept)."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T05:28:34Z"
type = "ui"
summary = "Make composer send button wider"
details = "Increased the PromptInput submit button width (and matched height to the other composer icon buttons) to give it more visual weight in the composer toolbar."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T05:30:21Z"
type = "ui"
summary = "Add right padding to composer action row"
details = "Added a small right padding to the composer action button row so the send button doesn't sit flush against the input group border."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T07:46:59Z"
type = "chore"
summary = "Clean up merged scaffold branches"
details = "Deleted the merged `work/scaffold` branch locally and on origin after merging it into `main`."
files = ["PROGRESS.toml"]

[[events]]
ts = "2026-01-14T07:46:59Z"
type = "hardening"
summary = "Add admin backup/export and reset tools behind an env flag"
details = "Added admin-only endpoints for exporting a full JSON backup and resetting (wiping) the local SQLite DB. Because the app is local-LAN and has no auth, these endpoints and the UI entrypoint are disabled by default and only enabled when `REMCOCHAT_ENABLE_ADMIN=1` is set. Also forced the home route to be dynamic to avoid build-time DB reads producing invalid IDs when the runtime DB path differs (important for E2E and for local deployments)."
tests = ["npm run build (pass)", "npm run test:e2e (pass)"]
files = [
  "src/server/admin.ts",
  "src/app/api/admin/export/route.ts",
  "src/app/api/admin/reset/route.ts",
  "src/app/page.tsx",
  "src/app/home-client.tsx",
  "playwright.config.ts",
  "e2e/instructions.spec.ts",
  "README.md",
  ".env.example",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-14T07:49:46Z"
type = "chore"
summary = "Merged admin-tools branch into main and cleaned up branch refs"
details = "Fast-forward merged `work/admin-tools` into `main`, pushed `main`, then deleted the merged `work/admin-tools` branch locally and on origin to keep the workflow lightweight."
tests = ["git status -sb (clean)"]
files = ["PROGRESS.toml"]

[[events]]
ts = "2026-01-14T08:35:27Z"
type = "ux"
summary = "New chats inherit the last-used model"
details = "Persisted the last-used model per profile (localStorage) and used it when creating a new chat (including the auto-create path after deleting the last chat). Updated the WebKit E2E suite to avoid hard-coding model ids so it stays compatible with allowlist changes."
tests = ["npm run test:e2e (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "playwright.config.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T08:41:35Z"
type = "ui"
summary = "Model picker closes after selection"
details = "Made the model selector dialog controlled so selecting a model automatically closes the dialog (no extra click/Escape). Updated E2E helper expectations accordingly."
tests = ["npm run build (pass)", "npx playwright test e2e/instructions.spec.ts -g \"Regenerate creates\" (pass)"]
files = ["src/components/model-picker.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T08:50:59Z"
type = "ui"
summary = "Focus composer after model selection"
details = "After selecting a model, the model picker now closes and then moves focus to the composer textarea (and places the cursor at the end) so the user can keep typing without extra clicks."
tests = ["npx playwright test e2e/instructions.spec.ts -g \"Profile \\+ chat instructions\" (pass)"]
files = ["src/components/model-picker.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T08:57:48Z"
type = "ui"
summary = "Switch light theme accent from blue to green"
details = "Updated the light theme OKLCH accent variables (primary/accent/ring and sidebar equivalents) from a blue hue to a green hue for clearer contrast in light mode."
tests = ["npm run build (pass)"]
files = ["src/app/globals.css", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T09:01:02Z"
type = "ui"
summary = "Adjust light accent hue to be greener"
details = "Moved the light theme accent hue away from cyan (150°) to a greener hue (132°) for a more clearly green accent in light mode."
tests = ["npm run build (pass)", "npx playwright test e2e/instructions.spec.ts -g \"Profile \\+ chat instructions\" (pass)"]
files = ["src/app/globals.css", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T09:08:10Z"
type = "feature"
summary = "Support deleting profiles"
details = "Added a profile delete API (`DELETE /api/profiles/:profileId`) with a confirmation guard, and exposed it in Profile settings with a destructive confirmation dialog. Deleting a profile cascades to its chats/messages/variants and memories via SQLite foreign keys."
tests = ["npm run build (pass)", "npx playwright test e2e/instructions.spec.ts -g \"Delete profile works\" (pass)"]
files = ["src/server/profiles.ts", "src/app/api/profiles/[profileId]/route.ts", "src/app/home-client.tsx", "e2e/instructions.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T09:15:09Z"
type = "ops"
summary = "Pruned local DB to only keep Default and Remco profiles"
details = "Stopped the local Next server to avoid concurrent DB access, created a timestamped backup of the SQLite database files, then deleted every profile except the oldest 'Default' and oldest 'Remco' records (including removing duplicates). Verified only 2 profiles remain; cascades removed related chats/messages/memories for deleted profiles. Existing chats under Default/Remco were preserved."
tests = ["Node one-off prune script (printed counts: profiles=2, chats=54, messages=381, variants=91)"]
files = ["PROGRESS.toml"]

[[events]]
ts = "2026-01-14T13:32:24Z"
type = "ui"
summary = "Move Temp toggle to header"
details = "Moved the Temporary chat toggle button from the sidebar profile footer to the top-right header next to the model label."
tests = ["npm run build (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T13:35:32Z"
type = "ui"
summary = "Use lock icon for temp toggle"
details = "Replaced the Temp text button with an icon-only lock toggle: open lock in normal mode, closed lock in temporary chat mode."
tests = ["npm run build (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T13:40:05Z"
type = "ui"
summary = "Increase spacing between model label and temp toggle"
details = "Increased the gap between the model label and the temp-mode lock button in the header for better visual breathing room."
tests = ["npm run build (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T13:46:07Z"
type = "ui"
summary = "Color temp lock toggle by mode"
details = "Updated the header temp-mode lock toggle styling so it is green in normal mode (unlocked) and red in temporary chat mode (locked), while keeping the icon-only affordance."
tests = ["npm run build (pass)", "npm run lint (pass; warnings)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T14:19:13Z"
type = "ui"
summary = "Temp mode turns composer red"
details = "When temporary chat mode is active, the composer border is forced to the destructive (red) color and the send button switches to the destructive variant; both revert to normal styling when temp mode is turned off."
tests = [
  "npm run build (pass)",
  "npx playwright test e2e/instructions.spec.ts -g \"Temporary chat turns composer red\" (pass)",
  "npm run lint (pass; warnings)",
]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T14:24:31Z"
type = "ui"
summary = "Make temp toggle color transitions consistent"
details = "Adjusted the temp-mode lock toggle so the same elements (border, icon/text color, and background) are tinted in both modes: green-ish when unlocked and red when locked."
tests = [
  "npm run build (pass)",
  "npx playwright test e2e/instructions.spec.ts -g \"Temporary toggle uses consistent colored elements\" (pass)",
]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T14:37:51Z"
type = "ui"
summary = "Use composer border color for unlocked temp toggle"
details = "Replaced the unlocked (normal) temp toggle green styling with the same neutral border color used by the composer (`border-input`), while keeping the locked (temp) state red."
tests = [
  "npm run build (pass)",
  "npx playwright test e2e/instructions.spec.ts -g \"Temporary toggle uses consistent colored elements|Temporary chat turns composer red\" (pass)",
]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T14:42:46Z"
type = "ui"
summary = "Match unlocked temp toggle to composer in both themes"
details = "Tweaked the unlocked temp toggle to use a transparent background (like the composer input group in light mode) and removed the green-ish accent hover so the default appearance matches the composer border in both light and dark themes."
tests = [
  "npm run build (pass)",
  "npx playwright test e2e/instructions.spec.ts -g \"Temporary toggle uses consistent colored elements|Temporary chat turns composer red\" (pass)",
]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T14:47:39Z"
type = "ui"
summary = "Use theme ring color for unlocked temp icon"
details = "Adjusted the unlocked temp toggle to use `text-ring` (green-ish in light theme, blue-ish in dark theme) so the lock icon color matches the composer’s focused border/ring color; locked state remains destructive red."
tests = [
  "npm run build (pass)",
  "npx playwright test e2e/instructions.spec.ts -g \"Temporary toggle uses consistent colored elements|Temporary chat turns composer red\" (pass)",
]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T14:51:54Z"
type = "ui"
summary = "Make dark unlocked temp border match icon"
details = "Fixed a specificity issue where the outline button’s `dark:border-input` overrode `border-ring/50`; added an explicit `dark:border-ring/50` so the unlocked border matches the blue-ish ring/icon color in dark mode."
tests = ["npm run build (pass)", "npx playwright test e2e/instructions.spec.ts -g \"Temporary toggle uses consistent colored elements\" (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T15:00:53Z"
type = "meta"
summary = "Roadmap 11 (Polish) confirmed complete"
details = "Marked Implementation Roadmap step 11 (Polish) as done in PLAN.md after user confirmation."
files = ["PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T15:09:26Z"
type = "fix"
summary = "Theme toggle returns focus to composer"
details = "Toggling the theme (click or Cmd/Ctrl+Shift+L) now requests composer focus so the typing flow continues uninterrupted. Implemented via a small app-level custom event that HomeClient handles while respecting open dialogs."
tests = [
  "npm run build (pass)",
  "npx playwright test e2e/instructions.spec.ts -g \"Theme toggle restores composer focus\" (pass)",
]
files = ["src/components/theme-toggle.tsx", "src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T15:16:08Z"
type = "ui"
summary = "Show app version in sidebar"
details = "Added a subtle version label in the sidebar footer so it's easy to report what build is running without cluttering the UI."
tests = ["npm run build (pass)", "npx playwright test e2e/instructions.spec.ts -g \"App shows version\" (pass)"]
files = ["src/app/page.tsx", "src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T15:18:48Z"
type = "ui"
summary = "Use icon-only new profile button"
details = "Replaced the profile 'New' button label with an icon-only plus button (aria-label/title kept) to match the icon-only control style."
tests = ["npm run build (pass)", "npx playwright test e2e/instructions.spec.ts -g \"New chat uses last selected model\" (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T15:22:21Z"
type = "ui"
summary = "Use icon-only new chat button"
details = "Replaced the sidebar chat list 'New' button label with an icon-only plus button (aria-label/title kept) to match the icon-only control style."
tests = ["npm run build (pass)", "npx playwright test e2e/instructions.spec.ts -g \"New chat uses last selected model\" (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T15:28:33Z"
type = "ui"
summary = "Use iOS-like toggle for profile memory"
details = "Replaced the profile settings memory On/Off button with an iOS-style toggle switch (role=switch, aria-checked) for a clearer visual indication of state."
tests = ["npm run build (pass)", "npx playwright test e2e/instructions.spec.ts -g \"Profile \\+ chat instructions stay effective\" (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-14T15:38:49Z"
type = "fix"
summary = "Restore composer focus after re-selecting active profile"
details = "Selecting the currently active profile doesn't change state, so the existing focus-on-change effect never runs; added Select open-state tracking and focus the composer when the dropdown closes."
tests = [
  "npm run build (pass)",
  "npm run test:e2e -- -g \"Profile reselect restores composer focus\" (pass)",
]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T04:48:02Z"
type = "feat"
summary = "Add weather tool (generative UI)"
details = "Added a `displayWeather` tool backed by Open-Meteo (geocoding + forecast), wired it into `/api/chat` tool-calling, and rendered the returned tool part as a Weather card in the chat UI."
tests = ["npm run lint (pass; warnings exist in other files)", "npm run build (pass)", "npm run test:e2e (pass)"]
files = [
  "src/ai/weather.ts",
  "src/ai/tools.ts",
  "src/app/api/chat/route.ts",
  "src/components/weather.tsx",
  "src/app/home-client.tsx",
  "e2e/weather-tool.spec.ts",
  "package.json",
  "package-lock.json",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-15T04:57:33Z"
type = "fix"
summary = "Stop after weather tool call to avoid duplicate text"
details = "Adjusted `/api/chat` to stop the tool-calling loop immediately after `displayWeather` is invoked so the UI card isn't followed by a redundant textual summary."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Weather tool renders a card\" (pass)"]
files = ["src/app/api/chat/route.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:01:39Z"
type = "ui"
summary = "Add condition icons to weather card"
details = "Rendered a small Lucide icon for current conditions and each forecast day (mapped from Open-Meteo weather codes) to make the weather card more glanceable."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Weather tool renders a card\" (pass)"]
files = ["src/ai/weather.ts", "src/components/weather.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:07:24Z"
type = "ui"
summary = "Align weather card daily rows"
details = "Switched the daily forecast rows to a fixed column grid (day / icon / condition / temps) so values line up cleanly across rows."
tests = ["npm run build (pass)"]
files = ["src/components/weather.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:11:51Z"
type = "feat"
summary = "Add weather forecast tool + card"
details = "Added a separate `displayWeatherForecast` tool (7-day default) and a Forecast card renderer, plus stopping behavior to avoid redundant text after tool output."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Forecast tool renders a card\" (pass)"]
files = [
  "src/ai/weather.ts",
  "src/ai/tools.ts",
  "src/app/api/chat/route.ts",
  "src/components/weather-icons.ts",
  "src/components/weather.tsx",
  "src/components/weather-forecast.tsx",
  "src/app/home-client.tsx",
  "e2e/weather-tool.spec.ts",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-15T05:16:57Z"
type = "ui"
summary = "Polish weather + forecast card styling"
details = "Improved visual hierarchy and polish: gradient card backgrounds, icon chips, badges for 'Now' / day range, and hoverable aligned forecast rows."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Weather tool renders a card|Forecast tool renders a card\" (pass)"]
files = ["src/components/weather.tsx", "src/components/weather-forecast.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:20:15Z"
type = "ui"
summary = "Move current condition icon next to temperature"
details = "Adjusted the weather card layout so the current condition icon sits directly next to the current temperature (and is larger), instead of being placed in the header."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Weather tool renders a card\" (pass)"]
files = ["src/components/weather.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:25:03Z"
type = "ui"
summary = "Use sunny sky-blue card backgrounds"
details = "Updated weather and forecast cards to use a brighter sky-blue gradient background while keeping dark mode subtle."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Weather tool renders a card|Forecast tool renders a card\" (pass)"]
files = ["src/components/weather.tsx", "src/components/weather-forecast.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:27:23Z"
type = "ui"
summary = "Reduce dark background in weather cards"
details = "Adjusted dark-mode gradients and header surfaces to avoid the cards looking overly black while keeping contrast and readability."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Weather tool renders a card|Forecast tool renders a card\" (pass)"]
files = ["src/components/weather.tsx", "src/components/weather-forecast.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:31:25Z"
type = "ui"
summary = "Add condition-based tinting to weather cards"
details = "Kept the sky-blue base but varied the gradient end color + accent icon color based on the Open-Meteo weather code (sunny=warm amber, rain=blue, snow=indigo, etc.)."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Weather tool renders a card|Forecast tool renders a card\" (pass)"]
files = ["src/components/weather-theme.ts", "src/components/weather.tsx", "src/components/weather-forecast.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:33:52Z"
type = "revert"
summary = "Revert condition-based tinting on weather cards"
details = "Removed per-condition background/icon tinting because it looked confusing; restored a consistent sunny sky-blue background for both cards."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Weather tool renders a card|Forecast tool renders a card\" (pass)"]
files = ["src/components/weather.tsx", "src/components/weather-forecast.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:36:43Z"
type = "ui"
summary = "Use solid sky-blue weather card backgrounds"
details = "Removed gradients from weather + forecast cards and switched to solid sky-blue backgrounds for a simpler, less distracting look."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Weather tool renders a card|Forecast tool renders a card\" (pass)"]
files = ["src/components/weather.tsx", "src/components/weather-forecast.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T05:41:00Z"
type = "fix"
summary = "Prevent forecast header icon clipping"
details = "Made the forecast header left content shrinkable and the calendar icon container non-shrinking so the icon never gets clipped when the header text wraps."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Forecast tool renders a card\" (pass)"]
files = ["src/components/weather-forecast.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T06:19:23Z"
type = "feat"
summary = "Show memory usage as a card in chat"
details = "When profile memory is enabled and non-empty, `/api/chat` injects a `data-memory` part into assistant responses so the UI can render a distinct 'Memory used' card (brain icon, brown/amber styling) to clearly indicate context coming from saved memory."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Memory retrieval shows a memory card\" (pass)"]
files = [
  "src/components/memory-card.tsx",
  "src/app/api/chat/route.ts",
  "src/app/home-client.tsx",
  "e2e/memory-card.spec.ts",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-15T06:25:14Z"
type = "ui"
summary = "Remove explanatory text from memory card"
details = "Simplified the memory card so it only shows the retrieved memory text (plus the brain icon), removing labels/description and the '...and more' footer."
tests = ["npm run build (pass)", "npm run test:e2e -- -g \"Memory retrieval shows a memory card\" (pass)"]
files = ["src/components/memory-card.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T06:39:25Z"
type = "feat"
summary = "Show memory-derived answers inside a memory card"
details = "Replaced the `data-memory` injection with a `displayMemoryAnswer` tool so memory-derived answers render exclusively inside the brown/amber brain card. The UI suppresses normal assistant text for that message so there is no duplicate response outside the card."
tests = ["npm run test:e2e -- -g \"Memory retrieval\" (pass)"]
files = [
  "src/ai/tools.ts",
  "src/app/api/chat/route.ts",
  "src/app/home-client.tsx",
  "src/components/memory-card.tsx",
  "e2e/memory-card.spec.ts",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-15T06:57:54Z"
type = "ui"
summary = "Render 'Saved to memory' as a brain card"
details = "Changed the explicit memory-save confirmation ('Saved to memory.') to return a `displayMemoryAnswer` tool part so it renders as the same brown/amber brain card (with no standalone assistant text)."
tests = ["npm run test:e2e -- -g \"Memory retrieval\" (pass)"]
files = ["src/app/api/chat/route.ts", "e2e/memory-card.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T07:09:20Z"
type = "ui"
summary = "Tighten memory card spacing"
details = "Centered the brain icon vertically within the card content, removed the default `Card` vertical padding for this component, and tightened the memory card content padding for a more compact look."
tests = ["npm run test:e2e (pass)"]
files = ["src/components/memory-card.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T07:21:43Z"
type = "fix"
summary = "Prevent profile settings dialog overflow from long memory"
details = "Constrained the profile settings dialog height and made its body scrollable, and ensured long memory items wrap within the available width so the modal no longer stretches outside the viewport."
tests = ["npm run test:e2e -- -g \"Profile settings stays within viewport\" (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T07:39:30Z"
type = "ui"
summary = "Add scrollbar clearance in profile settings"
details = "Added extra right padding in the scrollable profile settings body so the scrollbar doesn't visually overlap the right borders of the inner setting boxes."
tests = ["npm run test:e2e -- -g \"Profile settings stays within viewport\" (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T07:42:45Z"
type = "ui"
summary = "Move profile settings scrollbar closer to dialog edge"
details = "Split the profile settings body into an outer scroll container with minimal right padding (scrollbar closer to the dialog edge) and an inner content wrapper with right padding (keeps borders clear of the scrollbar)."
tests = ["npm run test:e2e -- -g \"Profile settings stays within viewport\" (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T07:50:23Z"
type = "fix"
summary = "Prevent page-level scrolling of the app canvas"
details = "Constrained `html`/`body` to the viewport and disabled page overflow so the chat UI can't be scrolled out of view; internal panels keep their own scroll behavior."
tests = ["npm run test:e2e -- -g \"App canvas stays within viewport\" (pass)"]
files = ["src/app/layout.tsx", "src/app/globals.css", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T08:05:30Z"
type = "fix"
summary = "Create a new chat when no active chats remain"
details = "Adjusted chat refresh/selection so archived chats are never auto-selected when the active chat list becomes empty. When the last active chat is archived or deleted (even if archived chats exist), RemcoChat now creates and selects a new unarchived chat instead."
tests = ["npm run test:e2e -- -g \"Archiving/deleting last active chat\" (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T08:19:18Z"
type = "chore"
summary = "Add Docker Compose for LAN hosting"
details = "Added a `docker-compose.yml` + `Dockerfile` for running RemcoChat on a home server (LAN-only) with a persistent named volume for SQLite data."
tests = ["docker compose build (pass)"]
files = ["docker-compose.yml", "Dockerfile", ".dockerignore", "README.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T11:47:57Z"
type = "ui"
summary = "Show copyright notice in sidebar footer"
details = "Appended '(c) kaaLabs '26' next to the app version in the sidebar footer."
tests = ["npm run test:e2e -- -g \"App shows version\" (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T12:49:02Z"
type = "ui"
summary = "Adjust light theme background surfaces"
details = "Updated the light theme base surface colors to match the provided screenshot: background `#F7F7F4` and card/sidebar `#F2F1ED`."
tests = ["npm run test:e2e -- -g \"Light theme uses gray canvas colors\" (pass)"]
files = ["src/app/globals.css", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T13:03:19Z"
type = "ui"
summary = "Replace light theme green accent with sand tone"
details = "Updated light theme tokens to use sand tones: `--primary`/`--ring` `#A49F7B` and a softer `--accent`/sidebar accent `#E7E5DC`. Also aligned a remaining success icon to `text-primary` and fixed lint errors discovered while validating."
tests = ["npm run lint (pass, warnings)", "npm run test:e2e (pass)"]
files = ["src/app/globals.css", "src/components/ai-elements/tool.tsx", "src/components/weather.tsx", "src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T13:19:31Z"
type = "ui"
summary = "Switch light theme accent to RGB 157,164,123"
details = "Updated the light theme accent tokens so the green-ish UI accents (send button, temp chat toggle, focused composer border, sidebar selection) use `--primary`/`--ring` `rgb(157 164 123)` and a matching sidebar/hover accent tint `#D9DACB`."
tests = ["npm run test:e2e (pass)", "npm run lint (pass, warnings)"]
files = ["src/app/globals.css", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T13:26:35Z"
type = "ui"
summary = "Match prompt bubble and user bubble to sidebar surface"
details = "Adjusted the prompt area background and user message bubble background to use `bg-sidebar` so they match the left sidebar surface in both light and dark themes."
tests = ["npm run test:e2e (pass)", "npm run lint (pass, warnings)"]
files = ["src/app/home-client.tsx", "src/components/ai-elements/message.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T13:32:16Z"
type = "ui"
summary = "Use olive accent for user prompt bubbles"
details = "Changed user message bubbles (the prompt bubbles) to use `bg-primary` so in light theme they render as `rgb(157, 164, 123)`."
tests = ["npm run test:e2e (pass)", "npm run lint (pass, warnings)"]
files = ["src/components/ai-elements/message.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T13:34:11Z"
type = "ui"
summary = "Match user prompt bubble to chat selector highlight"
details = "Updated user message bubbles to use `bg-sidebar-accent`/`text-sidebar-accent-foreground`, matching the active chat selector bar styling."
tests = ["npm run test:e2e (pass)", "npm run lint (pass, warnings)"]
files = ["src/components/ai-elements/message.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T13:40:51Z"
type = "chore"
summary = "Bump version to 0.9.2"
details = "Bumped the app version to 0.9.2 after merging the light-theme UI updates into `main`."
tests = ["npm run lint (pass, warnings)", "npm run test:e2e (pass)"]
files = ["package.json", "package-lock.json", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T13:47:43Z"
type = "chore"
summary = "Add cron-friendly update script"
details = "Added `scripts/update-remcochat.sh` which fetches `origin/main`, fast-forwards when updates exist, and restarts the Docker Compose stack only when needed (safe for hourly cron; ignores untracked files like `.env` but aborts on local tracked changes)."
tests = ["bash -n scripts/update-remcochat.sh (pass)"]
files = ["scripts/update-remcochat.sh", "README.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T15:05:31Z"
type = "feat"
summary = "Add config.toml provider foundation (read-only)"
details = "Introduced a global provider config foundation: added `config.toml.example` (tracked) + ignored `config.toml`, implemented a TOML+Zod config loader with a backwards-compatible internal default, and exposed the configured providers/models via `GET /api/providers` (read-only; active provider equals default for now)."
tests = ["npm run test:e2e -- -g \"Providers config endpoint\" (pass)"]
files = [".gitignore", "config.toml.example", "src/server/config.ts", "src/app/api/providers/route.ts", "e2e/providers-config.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T15:15:15Z"
type = "docs"
summary = "Document Vercel AI Gateway key in config example"
details = "Updated `config.toml.example` to include `providers.vercel.api_key_env = \"VERCEL_AI_GATEWAY_API_KEY\"` (with a note about the `AI_GATEWAY_API_KEY` fallback)."
tests = ["npm run test:e2e -- -g \"Providers config endpoint\" (pass)"]
files = ["config.toml.example", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T15:25:54Z"
type = "fix"
summary = "Require config.toml (fail fast; no internal defaults)"
details = "Removed the internal fallback config and made `config.toml` mandatory: `getConfig()` now errors when the config file is missing or not a file, `scripts/check-env.mjs` checks for the config before starting the app, and E2E boot now provisions an example config via `REMCOCHAT_CONFIG_PATH` so tests remain reproducible."
tests = ["npm run test:e2e -- -g \"Providers config endpoint\" (pass)"]
files = ["src/server/config.ts", "scripts/check-env.mjs", "src/app/page.tsx", "playwright.config.ts", "scripts/reset-e2e-db.mjs", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T15:26:35Z"
type = "docs"
summary = "Document required config.toml"
details = "Updated the README to include `cp config.toml.example config.toml` for both local dev and Docker usage, matching the new fail-fast requirement."
tests = ["npm run test:e2e -- -g \"Providers config endpoint\" (pass)"]
files = ["README.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T15:45:42Z"
type = "feat"
summary = "Persist active provider + add switching API"
details = "Added a global `app_settings` table and persisted `active_provider_id` in SQLite. `GET /api/providers` now reports the effective active provider (falls back to config default if the stored value no longer exists) and `PUT /api/providers/active` switches the provider (no auth/gating; validates the provider exists in `config.toml`). E2E config generation now injects an additional provider so switching can be tested."
tests = ["npm run test:e2e -- -g \"Switch active provider\" (pass)"]
files = ["src/server/db.ts", "src/server/app-settings.ts", "src/app/api/providers/route.ts", "src/app/api/providers/active/route.ts", "scripts/reset-e2e-db.mjs", "e2e/providers-switch.spec.ts", "e2e/providers-config.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T16:10:31Z"
type = "feat"
summary = "Make model list config-driven (remove hardcoded allowlist)"
details = "Removed the hardcoded model allowlist and made models fully config-driven per active provider: the UI model picker now loads options from `GET /api/providers` (active provider models only) and server-side profile/chat/chat-request model ids are validated/clamped against the active provider’s configured models (fallback to provider default when invalid)."
tests = ["npm run test:e2e -- -g \"Model selector uses config models\" (pass)"]
files = ["src/lib/models.ts", "src/server/model-registry.ts", "src/server/profiles.ts", "src/server/chats.ts", "src/app/api/chat/route.ts", "src/app/home-client.tsx", "scripts/reset-e2e-db.mjs", "e2e/model-selector-config.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T16:59:15Z"
type = "feat"
summary = "Route /api/chat through active provider adapter"
details = "Added a provider adapter layer so `/api/chat` resolves models through the globally active provider (from `config.toml` + persisted `active_provider_id`). Implemented adapters for Vercel AI Gateway and an OpenAI Responses-compatible gateway (eg OpenCode Zen), including model-id mapping (`provider_model_id`) and provider metadata headers on responses. Updated env checking + E2E boot config to support the second provider, and serialized Playwright workers to avoid global provider-switch races."
tests = ["npm run test:e2e (pass)"]
files = ["src/server/llm-provider.ts", "src/app/api/chat/route.ts", "src/server/config.ts", "scripts/check-env.mjs", "scripts/reset-e2e-db.mjs", "config.toml.example", "e2e/chat-provider.spec.ts", "e2e/model-selector-config.spec.ts", "playwright.config.ts", "package.json", "package-lock.json", "docker-compose.yml", ".env.example", "README.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T17:09:49Z"
type = "fix"
summary = "Decommission AI_GATEWAY_API_KEY fallback"
details = "Removed the undocumented `AI_GATEWAY_API_KEY` compatibility fallback. RemcoChat now only reads the provider key from `config.toml` (`providers.<id>.api_key_env`) and fails fast when it’s missing. Vercel AI Gateway is instantiated via `createGateway({ apiKey })`, so no env var mapping is needed."
tests = ["npm run test:e2e (pass)"]
files = ["src/server/llm-provider.ts", "scripts/check-env.mjs", "config.toml.example", ".env.example", "docker-compose.yml", "README.md", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T17:44:12Z"
type = "fix"
summary = "Require explicit provider base_url (no implicit defaults)"
details = "Made `providers.<id>.base_url` mandatory for all providers (including `vercel_ai_gateway`) to avoid relying on SDK defaults. Both runtime config validation and the preflight env check now fail fast when base_url is missing."
tests = ["npm run test:e2e (pass)"]
files = ["src/server/config.ts", "src/server/llm-provider.ts", "scripts/check-env.mjs", "config.toml.example", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T18:01:56Z"
type = "feat"
summary = "Add /admin panel route for provider switching"
details = "Added an `/admin` page (enabled only when `REMCOCHAT_ENABLE_ADMIN=1`) that lets you view and switch the globally active provider via `PUT /api/providers/active`. The sidebar Admin button now opens this panel in a new tab so you can switch providers at any moment. The admin panel also exposes the existing backup/export and reset controls."
tests = ["npm run test:e2e -- -g \"Admin panel switches provider\" (pass)", "npm run test:e2e (pass)"]
files = ["src/app/admin/page.tsx", "src/app/admin/admin-client.tsx", "src/app/home-client.tsx", "e2e/admin-provider-panel.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T19:04:42Z"
type = "feat"
summary = "Move provider type → model type; add OpenCode Zen Opus 4.5 support"
details = "Refactored `config.toml` so model `type` selects the adapter/API protocol (not the provider), enabling a single gateway provider to host mixed model APIs. Updated config parsing/validation, `/api/providers`, `/admin`, and `/api/chat` routing to use the selected model’s `type` (including Anthropic-compatible via `@ai-sdk/anthropic`). Updated config examples and E2E provisioning accordingly."
tests = [
  "npm run test:e2e -- -g \"Providers include anthropic model type\" (pass)",
  "npm run test:e2e (pass)",
]
files = [
  "src/server/config.ts",
  "src/server/llm-provider.ts",
  "src/app/api/chat/route.ts",
  "src/app/api/providers/route.ts",
  "src/app/admin/admin-client.tsx",
  "src/app/home-client.tsx",
  "scripts/check-env.mjs",
  "scripts/reset-e2e-db.mjs",
  "config.toml.example",
  "config.toml",
  "e2e/providers-config.spec.ts",
  "e2e/chat-provider.spec.ts",
  "e2e/providers-anthropic-type.spec.ts",
  "PLAN.md",
  "PROGRESS.toml",
]

[[events]]
ts = "2026-01-15T19:25:06Z"
type = "feat"
summary = "Align model type to OpenCode endpoint mapping"
details = "Adjusted model `type` values to match the concrete AI SDK protocol split for OpenCode Zen endpoints: `openai_responses` (OpenAI `/responses` via `@ai-sdk/openai`), `anthropic_messages` (Anthropic `/messages` via `@ai-sdk/anthropic`), and `openai_compatible` (OpenAI-compatible `/chat/completions` via `@ai-sdk/openai-compatible`). Added the OpenAI-compatible adapter, updated config examples + E2E provisioning, and kept all base URLs explicit in config."
tests = ["npm run test:e2e (pass)"]
files = ["src/server/config.ts", "src/server/llm-provider.ts", "scripts/check-env.mjs", "scripts/reset-e2e-db.mjs", "config.toml.example", "config.toml", "e2e/chat-provider.spec.ts", "e2e/providers-anthropic-type.spec.ts", "package.json", "package-lock.json", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T20:20:59Z"
type = "feat"
summary = "Add Google Generative AI model type + harden chat stream tests"
details = "Added the `google_generative_ai` model type (Gemini) via `@ai-sdk/google` so a gateway provider can expose Google models alongside other protocols. Tightened weather prompting to require tool-only output for weather queries, and hardened API-level E2E tests to parse the UI message SSE stream (fail on `error` chunks) with retries for transient OpenCode concurrency errors. The Google/Gemini E2E test is gated by `REMCOCHAT_E2E_ENABLE_GOOGLE_GEMINI=1` because Gemini models are disabled for the current OpenCode key."
tests = ["npm run test:e2e (26 passed, 1 skipped)"]
files = ["src/server/config.ts", "src/server/llm-provider.ts", "scripts/check-env.mjs", "scripts/reset-e2e-db.mjs", "config.toml.example", "package.json", "package-lock.json", "src/app/api/chat/route.ts", "e2e/ui-message-stream.ts", "e2e/chat-provider.spec.ts", "e2e/providers-anthropic-type.spec.ts", "e2e/model-types.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-15T20:48:51Z"
type = "feat"
summary = "Add model capabilities to config and apply them at runtime"
details = "Extended `config.toml` model entries with a required `capabilities` block (tools, temperature, attachments, structured_output). `/api/providers` now exposes per-model capabilities, and `/api/chat` respects them: it disables tool calling (no tools passed + no tool instructions in the system prompt) when `tools=false`, and omits the `temperature` parameter when `temperature=false`. Updated `config.toml.example` and E2E config generation accordingly and added an E2E test to verify that a tools-disabled model returns plain text with no tool chunks."
tests = ["npm run test:e2e (27 passed, 1 skipped)"]
files = ["src/server/config.ts", "src/server/llm-provider.ts", "src/app/api/chat/route.ts", "src/app/api/providers/route.ts", "scripts/check-env.mjs", "scripts/reset-e2e-db.mjs", "config.toml.example", "PLAN.md", "e2e/model-capabilities.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T17:12:38Z"
type = "feat"
summary = "Require confirmation before saving chat memory"
details = "Updated the system prompt and chat memory command flow to ask for explicit confirmation before saving. Added pending-memory storage with confirmation/cancel handling, refreshed copy in the profile settings UI, and updated the memory-related E2E coverage for the two-step flow."
tests = ["npm run test:e2e -- -g \"Memory retrieval shows a memory card|Profile settings stays within viewport with long memory items\" (pass)"]
files = ["src/server/db.ts", "src/server/pending-memory.ts", "src/server/admin.ts", "src/app/api/chat/route.ts", "src/app/home-client.tsx", "e2e/memory-card.spec.ts", "e2e/instructions.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T17:19:03Z"
type = "feat"
summary = "Expand memory intent detection beyond \"Memorize this\""
details = "Extended the chat-side memory capture parser to recognize natural-language intents (remember/save/store/note, including \"...to memory\" forms) while still requiring confirmation before saving. Updated UI copy + plan notes and adjusted the memory-related E2E flows to use the new phrasing."
tests = ["npm run test:e2e -- -g \"Memory retrieval shows a memory card|Profile settings stays within viewport with long memory items\" (pass)"]
files = ["src/app/api/chat/route.ts", "src/app/home-client.tsx", "e2e/memory-card.spec.ts", "e2e/instructions.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T18:04:37Z"
type = "feat"
summary = "Add server-side intent router for memory and weather workflows"
details = "Introduced an LLM-backed intent router that classifies memory/weather intents server-side and routes `/api/chat` accordingly (memory confirmation or weather tool cards). Added router config (provider/model/min_confidence/max_input_chars), provider-scoped model resolution, and a prefilter to skip routing for generic questions. Hardened structured-output schema requirements for Vercel AI Gateway and aligned the memory E2E wait with the two-message confirmation flow."
tests = ["npm run test:e2e -- -g \"Memory retrieval shows a memory card|Weather tool renders a card|Forecast tool renders a card\" (pass)"]
files = ["src/server/intent-router.ts", "src/server/config.ts", "src/server/llm-provider.ts", "src/app/api/chat/route.ts", "scripts/check-env.mjs", "config.toml.example", "e2e/memory-card.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T18:20:45Z"
type = "fix"
summary = "Skip weather routing when tools are disabled"
details = "Adjusted intent routing so weather intents only short-circuit to tool UI when the resolved model allows tools, preventing tool chunks for tools-disabled models. Added typed model resolution caching to keep the router/tool gate explicit."
tests = ["npm run test:e2e (27 passed, 1 skipped)"]
files = ["src/app/api/chat/route.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T18:43:12Z"
type = "feat"
summary = "Show memory confirmation as a prompt card with buttons"
details = "Replaced the text confirmation prompt with a memory-styled card that includes Yes/No actions. Added a memory prompt card component, streamed it via a new UI tool part, and updated E2E coverage to click the prompt buttons and accept either a memory card or plain-text answer for retrieval."
tests = ["npm run test:e2e -- -g \"Memory retrieval shows a memory card|Profile settings stays within viewport with long memory items\" (pass)"]
files = ["src/components/memory-prompt-card.tsx", "src/app/api/chat/route.ts", "src/app/home-client.tsx", "e2e/memory-card.spec.ts", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T18:57:42Z"
type = "feat"
summary = "Require contextual memory candidates"
details = "Updated the intent router prompt to require self-contained memory candidates and added a server-side guard that asks for more context when the memory text is a single word. This prevents storing context-free memories and aligns memory prompts with future retrieval needs."
tests = ["npm run test:e2e -- -g \"Memory retrieval shows a memory card|Profile settings stays within viewport with long memory items\" (pass)"]
files = ["src/server/intent-router.ts", "src/app/api/chat/route.ts", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T19:06:59Z"
type = "feat"
summary = "Delete chats without a confirmation dialog"
details = "Removed the delete confirmation modal so chat history deletions happen immediately from the sidebar menu. Added inline error feedback in the sidebar and updated E2E coverage to reflect the new flow."
tests = ["npm run test:e2e -- -g \"Archive/delete and export work|Archiving/deleting last active chat\" (pass)"]
files = ["src/app/home-client.tsx", "e2e/instructions.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T19:42:04Z"
type = "feat"
summary = "Add to-do and grocery list tool with interactive cards"
details = "Implemented profile-scoped lists with list items in SQLite, added the displayList tool for list creation/updates, and built an interactive list card with toggle/remove/clear actions. Added list API routes, admin export/reset coverage for lists, and a Playwright E2E to validate the card."
tests = ["npm run test:e2e -- -g \"List tool renders a card\" (pass)"]
files = ["src/server/db.ts", "src/server/lists.ts", "src/app/api/profiles/[profileId]/lists/route.ts", "src/ai/tools.ts", "src/app/api/chat/route.ts", "src/components/list-card.tsx", "src/app/home-client.tsx", "src/server/admin.ts", "e2e/list-tool.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T20:36:42Z"
type = "feat"
summary = "Enable shared lists across profiles"
details = "Added list membership storage and share/unshare actions with owner-only permissions. Lists now resolve shared access by name or id, and list cards label shared lists. Prevented chat state sync from saving across profile switches, and updated tool/system guidance for sharing."
tests = ["npm run test:e2e -- -g \"Shared lists sync across profiles\" (pass)"]
files = ["src/server/db.ts", "src/server/lists.ts", "src/app/api/profiles/[profileId]/lists/route.ts", "src/ai/tools.ts", "src/app/api/chat/route.ts", "src/components/list-card.tsx", "src/app/home-client.tsx", "src/server/admin.ts", "e2e/list-tool.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T20:44:54Z"
type = "fix"
summary = "Show shared badge on owner list cards"
details = "Added shared member counts to list outputs so owners see the Shared tag when a list is shared. Updated the shared-list E2E test to assert the badge."
tests = ["npm run test:e2e -- -g \"Shared lists sync across profiles\" (pass)"]
files = ["src/server/lists.ts", "src/lib/types.ts", "src/components/list-card.tsx", "e2e/list-tool.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T20:53:08Z"
type = "feat"
summary = "Add list deletion support"
details = "Added delete_list actions for tools/API, owner-only deletion, and list cards that show a Deleted state with the new delete button. Updated the system tool guidance and added an E2E test for list deletion."
tests = ["npm run test:e2e -- -g \"List tool deletes a list\" (pass)"]
files = ["src/server/lists.ts", "src/ai/tools.ts", "src/app/api/profiles/[profileId]/lists/route.ts", "src/app/api/chat/route.ts", "src/components/list-card.tsx", "src/lib/types.ts", "e2e/list-tool.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T21:05:43Z"
type = "fix"
summary = "Stop recreating deleted shared lists for members"
details = "Restricted implicit list creation to create/add_items (or show with items) so member profiles cannot recreate deleted shared lists by showing them. Clarified list tool instructions and extended the shared-list E2E to cover owner deletion and member access."
tests = ["npm run test:e2e -- -g \"Shared lists sync across profiles\" (pass)"]
files = ["src/server/lists.ts", "src/app/api/chat/route.ts", "e2e/list-tool.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T21:22:22Z"
type = "feat"
summary = "Add timezones tool card"
details = "Implemented a timezones tool that resolves city/IANA zones, formats current times, and supports reference-time conversions. Added a Timezones card UI, hooked tool rendering and stop conditions into chat, updated the system prompt guidance, and added an E2E test for the new card."
tests = ["npm run test:e2e -- -g \"Timezones tool renders a card\" (pass)"]
files = ["src/ai/timezones.ts", "src/ai/tools.ts", "src/components/timezones-card.tsx", "src/app/home-client.tsx", "src/app/api/chat/route.ts", "e2e/timezones-tool.spec.ts", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T21:31:39Z"
type = "fix"
summary = "Geocode city names for timezones"
details = "Added an Open-Meteo geocoding fallback so unknown city names resolve to their IANA timezone, keeping the timezones card usable for non-alias inputs like smaller cities."
tests = ["npm run test:e2e -- -g \"Timezones tool renders a card\" (pass)"]
files = ["src/ai/timezones.ts", "e2e/timezones-tool.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T22:06:22Z"
type = "feat"
summary = "Add URL summary tool and card"
details = "Implemented URL summarization with HTML extraction, length/focus controls, and a new summary card with an open-link CTA. Wired the tool into chat prompts and tool handling, added unit coverage for extraction helpers, and added an E2E card smoke test."
tests = ["npm run test:unit (pass)", "npm run test:e2e -- -g \"URL summary tool renders a card\" (pass)"]
files = ["src/ai/url-summary.ts", "src/ai/tools.ts", "src/components/url-summary-card.tsx", "src/app/home-client.tsx", "src/app/api/chat/route.ts", "e2e/url-summary-tool.spec.ts", "tests/url-summary.test.ts", "package.json", "package-lock.json", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T22:17:30Z"
type = "fix"
summary = "Raise URL summary size cap"
details = "Increased the maximum HTML size threshold to 2 MB so large documentation pages can still be summarized before extraction." 
tests = ["npm run test:unit (pass)"]
files = ["src/ai/url-summary.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T22:29:36Z"
type = "feat"
summary = "Add quick notes tool and card"
details = "Implemented profile-scoped quick notes with create/show/delete actions, a new notes card UI with inline deletion, and API endpoints for notes. Wired tool instructions and stop conditions into chat, and added unit + E2E coverage."
tests = ["npm run test:unit (pass)", "npm run test:e2e -- -g \"Notes tool renders a card\" (pass)"]
files = ["src/server/db.ts", "src/server/notes.ts", "src/app/api/profiles/[profileId]/notes/route.ts", "src/ai/tools.ts", "src/app/api/chat/route.ts", "src/components/notes-card.tsx", "src/app/home-client.tsx", "src/lib/notes.ts", "src/lib/types.ts", "src/server/admin.ts", "e2e/notes-tool.spec.ts", "tests/notes.test.ts", "package.json", "package-lock.json", "PLAN.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-16T22:37:02Z"
type = "fix"
summary = "Route note phrases to quick notes instead of memory"
details = "Adjusted memory parsing and intent routing to ignore quick-note phrases like 'Note this', preventing them from triggering memory confirmation. Updated intent router guidance and the notes E2E prompt to cover the phrase." 
tests = ["npm run test:unit (pass)", "npm run test:e2e -- -g \"Notes tool renders a card\" (pass)"]
files = ["src/app/api/chat/route.ts", "src/server/intent-router.ts", "e2e/notes-tool.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-17T18:31:49Z"
type = "feat"
summary = "Enable seamless web tools for tool-capable models"
details = "Added an optional app.web_tools config block and wired provider-native web search/fetch tools into /api/chat so models can decide when to fetch up-to-date information. Increased step budget when web tools are enabled and added minimal system prompt guidance."
tests = ["npm run test:unit (pass)", "npm run build (pass)"]
files = ["src/server/config.ts", "config.toml.example", "src/server/llm-provider.ts", "src/ai/web-tools.ts", "src/app/api/chat/route.ts", "tests/config-web-tools.test.ts", "PLAN.md", "feat-webfetch-research.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-17T19:15:10Z"
type = "fix"
summary = "Make web tools discoverable to the model"
details = "Moved system prompt construction into a shared module, expanded the web-tools instruction so provider tools are discoverable by name (perplexity_search/web_search/web_fetch/etc), and added debug response headers exposing which web tools were injected per request."
tests = ["npm run test:unit (pass)", "npm run build (pass)"]
files = ["src/ai/system-prompt.ts", "src/app/api/chat/route.ts", "tests/system-prompt.test.ts", "feat-webfetch-research.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-17T19:50:00Z"
type = "fix"
summary = "Fix AI Gateway web tool result forwarding"
details = "When using provider-executed web tools (perplexity_search) with OpenAI models via AI Gateway, OpenAI Responses needs store=true to reference tool result items across steps. Added providerOptions.openai.store=true when web tools are enabled for OpenAI models to avoid repeated tool loops and warnings."
tests = ["npm run test:unit (pass)", "npm run build (pass)"]
files = ["src/ai/provider-options.ts", "src/app/api/chat/route.ts", "tests/provider-options.test.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-17T19:52:35Z"
type = "docs"
summary = "Document OpenAI store requirement for web tools"
details = "Noted that provider-executed web tools with OpenAI Responses require providerOptions.openai.store=true, otherwise tool results can't be referenced across steps and warnings/tool loops occur."
tests = ["npm run test:unit (pass)", "npm run build (pass)"]
files = ["feat-webfetch-research.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-17T20:37:14Z"
type = "fix"
summary = "Use OpenAI web_search for AI Gateway OpenAI models"
details = "Switched AI Gateway OpenAI models from perplexity_search to OpenAI's native web_search tool so the model returns a normal text answer. Also strip web tool call/result parts from messages (request + persisted chat state) to avoid warnings and context bloat, and removed the automatic store=true override."
tests = ["npm run test:unit (pass)", "npm run build (pass)"]
files = ["src/ai/web-tools.ts", "src/app/api/chat/route.ts", "src/server/message-sanitize.ts", "src/server/chats.ts", "src/ai/provider-options.ts", "tests/provider-options.test.ts", "tests/web-tools.test.ts", "tests/message-sanitize.test.ts", "feat-webfetch-research.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-17T21:08:39Z"
type = "feat"
summary = "Add web_fetch for Anthropic models via AI Gateway"
details = "When using non-OpenAI models through Vercel AI Gateway, keep web search via perplexity_search and additionally expose Anthropic's web_fetch tool for anthropic/* models so they can fetch and cite specific pages when needed."
tests = ["npm run test:unit (pass)", "npm run build (pass)"]
files = ["src/ai/web-tools.ts", "tests/web-tools.test.ts", "feat-webfetch-research.md", "PROGRESS.toml"]

[[events]]
ts = "2026-01-17T22:16:31Z"
type = "fix"
summary = "Auto-continue AI Gateway perplexity_search for non-OpenAI models"
details = "Some non-OpenAI models routed through Vercel AI Gateway would call provider-executed web tools (perplexity_search) and stop with an empty assistant message (finishReason=tool-calls). RemcoChat now buffers that first step and automatically runs a second pass that injects formatted search results as context (and removes perplexity_search) so the model produces a normal text answer. Also hardened message sanitization to strip web tool UI parts (tool-*) and ignore incomplete tool calls when converting UI messages to model messages to avoid Anthropic tool_use/tool_result mismatches."
tests = ["npm run test:unit (pass)", "npm run build (pass)", "agent-browser smoke: AI Gateway anthropic/* answers with URLs (pass)"]
files = ["src/app/api/chat/route.ts", "src/ai/perplexity.ts", "src/server/message-sanitize.ts", "tests/perplexity.test.ts", "tests/message-sanitize.test.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-17T23:12:46Z"
type = "fix"
summary = "Prevent list actions from triggering memory flow"
details = "Added list-intent detection so commands like 'add issue to the RemcoChat issues list' bypass memory parsing and intent routing. This keeps list updates in the list tool flow even when memory is disabled."
tests = ["npm run test:unit (pass)"]
files = ["src/server/list-intent.ts", "src/app/api/chat/route.ts", "tests/list-intent.test.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-18T01:07:22Z"
type = "feat"
summary = "Make the app shell responsive on mobile"
details = "Switched the main layout to a md breakpoint shell: desktop keeps the sidebar, mobile gets a drawer menu. Added safe-area padding and a small visualViewport-based keyboard inset helper to keep the composer usable on iOS. Theme toggle is always visible in the mobile header and the admin link now opens in the same tab."
tests = ["npm run test:unit (pass)", "npm run test:e2e (pass)"]
files = ["src/app/layout.tsx", "src/app/globals.css", "src/components/viewport-insets.tsx", "src/components/theme-provider.tsx", "src/app/home-client.tsx", "src/app/admin/admin-client.tsx", "e2e/mobile-shell.spec.ts", "e2e/instructions.spec.ts", "e2e/list-tool.spec.ts", "e2e/memory-card.spec.ts", "PROGRESS.toml"]

[[events]]
ts = "2026-01-18T01:12:05Z"
type = "fix"
summary = "Make mobile sidebar drawer dialog accessible"
details = "Added a visually-hidden DialogTitle to the mobile sidebar drawer to satisfy Radix Dialog accessibility requirements and remove the runtime console error."
tests = ["npm run test:unit (pass)"]
files = ["src/app/home-client.tsx", "PROGRESS.toml"]

[[events]]
ts = "2026-01-19T18:35:58Z"
type = "feat"
summary = "Derive model capabilities from modelsdev (with admin observability)"
details = "Switched to config v2 where providers only define connection info + an allowlist, and all model metadata/capabilities are derived via the `modelsdev` CLI at runtime (cached in-memory until server restart). The model picker now displays capability badges (incl. reasoning) from models.dev flags, `/api/providers` serves the derived catalog, and the admin UI exposes the in-memory catalog via `/api/admin/models-catalog`."
tests = ["npm run test:unit (pass)", "npm run test:e2e (pass)", "npm run test:agent-browser (pass)"]
files = ["src/server/config.ts", "src/server/modelsdev-catalog.ts", "src/server/llm-provider.ts", "src/server/model-registry.ts", "src/app/api/providers/route.ts", "src/app/api/admin/models-catalog/route.ts", "src/app/admin/admin-client.tsx", "src/components/model-picker.tsx", "src/lib/models.ts", "scripts/check-env.mjs", "scripts/reset-e2e-db.mjs", "e2e/model-selector-config.spec.ts", "e2e/model-capabilities.spec.ts", "config.toml.example", "scripts/test-agent-browser.mjs", "package.json", "docs/agents/testing.md", "PLAN.md", "README.md", "PROGRESS.toml"]
